// Generated by LiveScript 1.3.1
(function(){
  var lc, colorscale, move, legendView, render;
  lc = {
    target: '中華統一促進黨'
  };
  colorscale = d3.interpolateInferno;
  move = function(){
    if (window.innerWidth < 768) {
      return scrollto('#popularity-by-party-anchor');
    }
  };
  legendView = new ldView({
    root: 'div[ld-scope="popularity-by-party-map"]',
    initRender: false,
    handler: {
      label: {
        list: function(){
          return ([1].concat((function(){
            var i$, step$, to$, results$ = [];
            for (i$ = lc.range.max, to$ = lc.range.min, step$ = -lc.range.size / 6; step$ < 0 ? i$ >= to$ : i$ <= to$; i$ += step$) {
              results$.push(i$);
            }
            return results$;
          }()))).sort(function(a, b){
            return b - a;
          });
        },
        handle: function(arg$){
          var data, node, idx, v;
          data = arg$.data, node = arg$.node, idx = arg$.idx;
          v = (data - lc.range.min) / lc.range.size;
          node.style.order = idx;
          ld$.find(node, '.dot', 0).style.background = colorscale(v);
          return ld$.find(node, '.name', 0).innerHTML = ((data === 1 ? "<span class='text-sm'>(全國平均)</span>" : '') + "") + (Math.round(data * 100) / 100 + "<span class='text-sm'>倍</span>");
        }
      }
    }
  });
  render = debounce(50, function(){
    var rate, k, ref$, v, list, res$;
    lc.map.fit();
    lc.rate = rate = {};
    for (k in ref$ = lc.data) {
      v = ref$[k];
      if (k === '全國') {
        continue;
      }
      rate[k] = (v[lc.target] / v["總計"]) / (lc.data["全國"][lc.target] / lc.data["全國"]["總計"]);
    }
    res$ = [];
    for (k in rate) {
      v = rate[k];
      res$.push(v);
    }
    list = res$;
    lc.range = {
      min: Math.min.apply(null, list),
      max: Math.max.apply(null, list)
    };
    lc.range.size = lc.range.max - lc.range.min;
    legendView.render();
    return d3.select(lc.map.root).selectAll('path').attr('stroke', function(){
      return '#fff';
    }).attr('stroke-width', function(){
      return 0.001;
    }).transition().duration(350).attr('fill', function(it){
      var r, v;
      r = rate[it.properties.name];
      v = (r - lc.range.min) / (lc.range.max - lc.range.min);
      return colorscale(v);
    });
  });
  lc.map = pdmaptw.create({
    root: ld$.find(document, '#map-popularity-by-party-map', 0),
    type: 'town',
    popup: popupWrap(function(arg$){
      var data, evt, node;
      data = arg$.data, evt = arg$.evt, node = arg$.node;
      return node.innerHTML += "<div>" + Math.round(lc.rate[data.properties.name] * 100) / 100 + "<span class='text-sm'>倍</span></div>";
    })
  });
  return lc.map.init().then(function(){
    return ld$.fetch("assets/data/政黨票.json", {
      method: 'GET'
    }, {
      type: 'json'
    });
  }).then(function(data){
    var k;
    lc.data = data;
    return lc.party = (function(){
      var results$ = [];
      for (k in lc.data["台東縣成功鎮"]) {
        results$.push(k);
      }
      return results$;
    }()).filter(function(it){
      return it !== '總計';
    });
  }).then(function(){
    var view;
    view = new ldView({
      root: '[ld-scope="popularity-by-party"]',
      action: {
        input: {
          "party-select": function(arg$){
            var node;
            node = arg$.node;
            lc.target = node.value;
            view.getAll('party-select').map(function(it){
              return it.value = node.value;
            });
            move();
            return render();
          }
        },
        click: {
          "setparty": function(arg$){
            var node, value;
            node = arg$.node;
            lc.target = value = node.getAttribute('data-value');
            view.getAll('party-select').map(function(it){
              return it.value = value;
            });
            move();
            return render();
          }
        }
      },
      handler: {
        "party-option": {
          list: function(){
            return lc.party;
          },
          handle: function(arg$){
            var data, node;
            data = arg$.data, node = arg$.node;
            node.innerText = data;
            return node.setAttribute('value', data);
          }
        }
      }
    });
    return view.getAll('party-select').map(function(it){
      return it.value = "中華統一促進黨";
    });
  }).then(function(){
    return render();
  });
})();